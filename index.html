<script>
    // Configuration
    const premiumUsers = [
        "haivarunkarthik@gmail.com",
        "varunkarthiktrading@gmail.com",
        "aiwinsvarun@gmail.com"
    ];
    
    // API Keys - REMOVED for security (now handled by backend)
    const BACKEND_URL = "https://lizz-backend.onrender.com"; // UPDATE WITH YOUR ACTUAL BACKEND URL
    
    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const app = document.getElementById('app');
    const loginForm = document.getElementById('loginForm');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const newChat = document.getElementById('newChat');
    const historyList = document.getElementById('historyList');
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const pricingDropdown = document.getElementById('pricingDropdown');
    const pricingMenu = document.getElementById('pricingMenu');
    const userEmail = document.getElementById('userEmail');
    const autoLearningIndicator = document.getElementById('autoLearningIndicator');
    const progressBar = document.getElementById('progressBar');
    
    // Mode buttons
    const normalMode = document.getElementById('normalMode');
    const deepThinkMode = document.getElementById('deepThinkMode');
    const webSearchMode = document.getElementById('webSearchMode');
    
    // State
    let currentUser = null;
    let chatHistory = [];
    let fullHistory = [];
    let isPremium = false;
    let currentMode = 'normal'; // 'normal', 'deepthink', 'websearch'
    let autoLearningInterval = null;
    
    // Initialize
    function init() {
        // Check if user is already logged in
        const savedUser = localStorage.getItem('lizzUser');
        
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showApp();
        } else {
            showLogin();
        }
        
        // Load history
        loadHistory();
        
        // Set up event listeners
        setupEventListeners();
        
        // Start auto-learning
        startAutoLearning();
    }
    
    // Show login modal
    function showLogin() {
        loginModal.classList.remove('hidden');
        app.classList.add('hidden');
    }
    
    // Show main app
    function showApp() {
        loginModal.classList.add('hidden');
        app.classList.remove('hidden');
        userEmail.textContent = currentUser.email;
        
        // Check if user is premium
        isPremium = premiumUsers.includes(currentUser.email);
        if (isPremium) {
            document.querySelector('#pricingDropdown span').textContent = 'Premium';
            document.querySelector('#pricingDropdown i').className = 'fas fa-crown mr-1';
            document.querySelector('#pricingDropdown').classList.add('premium-badge');
        } else {
            document.querySelector('#pricingDropdown span').textContent = 'Upgrade';
            document.querySelector('#pricingDropdown i').className = 'fas fa-gem mr-1';
            document.querySelector('#pricingDropdown').classList.remove('premium-badge');
        }
    }
    
    // Load history
    function loadHistory() {
        historyList.innerHTML = '';
        const sampleHistory = [
            "Explain quantum computing in simple terms",
            "How do I make an HTTP request in JavaScript?",
            "Write a poem about artificial intelligence",
            "What's the difference between React and Vue?",
            "Show me how to center a div with CSS"
        ];
        
        sampleHistory.forEach((item, index) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item flex items-center p-3 rounded-md cursor-pointer truncate text-sm';
            historyItem.innerHTML = `
                <i class="fas fa-message mr-2 text-gray-500"></i>
                <span class="truncate">${item}</span>
            `;
            historyItem.addEventListener('click', () => {
                userInput.value = item;
                userInput.focus();
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
            historyList.appendChild(historyItem);
        });
    }
    
    // Add message to chat
    function addMessage(role, content, mode = 'normal') {
        const messageDiv = document.createElement('div');
        
        // Determine message style based on role and mode
        if (role === 'user') {
            messageDiv.className = 'message-user rounded-md p-4 mb-6 fade-in';
            messageDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center mr-3">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="text-gray-100 whitespace-pre-wrap">${content}</div>
                </div>
            `;
        } else if (mode === 'deepthink') {
            messageDiv.className = 'message-deepthink rounded-md p-4 mb-6 fade-in';
            messageDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-deepthink flex items-center justify-center mr-3">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <div class="text-gray-100 whitespace-pre-wrap">
                        <div class="flex items-center mb-2">
                            <span class="deepthink-badge text-xs px-2 py-0.5 rounded mr-2">DeepThink</span>
                            <span class="text-xs text-gray-300">Enhanced reasoning activated</span>
                        </div>
                        ${content}
                    </div>
                </div>
            `;
        } else if (mode === 'websearch') {
            messageDiv.className = 'message-websearch rounded-md p-4 mb-6 fade-in';
            messageDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-search flex items-center justify-center mr-3">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="text-gray-100 whitespace-pre-wrap">
                        <div class="flex items-center mb-2">
                            <span class="search-badge text-xs px-2 py-0.5 rounded mr-2">Web Search</span>
                            <span class="text-xs text-gray-300">Real-time data retrieved</span>
                        </div>
                        ${content}
                    </div>
                </div>
            `;
        } else {
            messageDiv.className = 'message-ai rounded-md p-4 mb-6 fade-in';
            messageDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary flex items-center justify-center mr-3">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="text-gray-300 whitespace-pre-wrap">${content}</div>
                </div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Call your secure backend API
    async function callLizzAI(prompt) {
        try {
            const response = await fetch(`${BACKEND_URL}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message: prompt,
                    mode: currentMode
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`API Error: ${error.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.response;
        } catch (error) {
            console.error("Lizz AI API Error:", error);
            return `Sorry, I encountered an error: ${error.message}. Please try again.`;
        }
    }
    
    // Handle user message
    async function handleUserMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        
        // Add user message
        addMessage('user', message);
        
        // Clear input
        userInput.value = '';
        userInput.style.height = 'auto';
        
        // Add to history
        fullHistory.push(message);
        if (fullHistory.length > 20) {
            fullHistory.shift();
        }
        loadHistory();
        
        // Show typing indicator
        typingIndicator.classList.remove('hidden');
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        try {
            // Get AI response from your secure backend
            const response = await callLizzAI(message);
            
            // Hide typing indicator and show response
            typingIndicator.classList.add('hidden');
            
            // Determine message type based on current mode
            addMessage('ai', response, currentMode);
        } catch (error) {
            typingIndicator.classList.add('hidden');
            addMessage('ai', `Error: ${error.message}`);
        }
    }
    
    // Switch modes
    function switchMode(mode) {
        currentMode = mode;
        
        // Update UI
        normalMode.classList.remove('active', 'bg-primary');
        deepThinkMode.classList.remove('active', 'bg-deepthink');
        webSearchMode.classList.remove('active', 'bg-search');
        
        normalMode.classList.add('bg-gray-700', 'text-gray-300');
        deepThinkMode.classList.add('bg-gray-700', 'text-gray-300');
        webSearchMode.classList.add('bg-gray-700', 'text-gray-300');
        
        if (mode === 'normal') {
            normalMode.classList.add('active', 'bg-primary');
            normalMode.classList.remove('bg-gray-700', 'text-gray-300');
        } else if (mode === 'deepthink') {
            deepThinkMode.classList.add('active', 'bg-deepthink');
            deepThinkMode.classList.remove('bg-gray-700', 'text-gray-300');
        } else if (mode === 'websearch') {
            webSearchMode.classList.add('active', 'bg-search');
            webSearchMode.classList.remove('bg-gray-700', 'text-gray-300');
        }
    }
    
    // Start auto-learning process
    function startAutoLearning() {
        // Show indicator
        autoLearningIndicator.classList.remove('hidden');
        
        // Simulate learning process
        let progress = 0;
        const interval = setInterval(() => {
            progress += 2;
            progressBar.style.width = `${progress}%`;
            
            if (progress >= 100) {
                clearInterval(interval);
                progressBar.style.width = '0%';
            }
        }, 20); // 100% in 5 seconds
        
        // In a real implementation, this would:
        // 1. Fetch latest information from knowledge sources
        // 2. Update internal models
        // 3. Process new data patterns
        // 4. Optimize response algorithms
        
        // Restart every minute
        setTimeout(startAutoLearning, 60000);
    }
    
    // Set up event listeners
    function setupEventListeners() {
        // Login form
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const remember = document.getElementById('remember').checked;
            
            // Simple validation
            if (email && password) {
                currentUser = { email, password };
                
                if (remember) {
                    localStorage.setItem('lizzUser', JSON.stringify(currentUser));
                }
                
                showApp();
            }
        });
        
        // Toggle sidebar
        toggleSidebar.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });
        
        // Close sidebar when clicking overlay
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });
        
        // New chat
        newChat.addEventListener('click', () => {
            chatMessages.innerHTML = '';
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });
        
        // Send message
        sendButton.addEventListener('click', handleUserMessage);
        
        // Send on Enter (without Shift)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserMessage();
            }
        });
        
        // Auto-resize textarea
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
        });
        
        // Pricing dropdown
        pricingDropdown.addEventListener('click', () => {
            pricingMenu.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!pricingDropdown.contains(e.target) && !pricingMenu.contains(e.target)) {
                pricingMenu.classList.add('hidden');
            }
        });
        
        // Mode switching
        normalMode.addEventListener('click', () => switchMode('normal'));
        deepThinkMode.addEventListener('click', () => switchMode('deepthink'));
        webSearchMode.addEventListener('click', () => switchMode('websearch'));
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', init);
</script>
